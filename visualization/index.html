<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>犯罪数据分析可视化平台</title>
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
            min-height: 400px;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .stats-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
        }
        .stats-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- 页面头部 -->
    <div class="header">
        <div class="container">
            <h1>犯罪数据分析可视化平台</h1>
            <p>基于Hive大数据分析的犯罪趋势与模式可视化</p>
        </div>
    </div>
    
    <!-- 主要内容 -->
    <div class="container">
        <!-- 统计卡片 -->
        <div class="row" id="stats-container">
            <!-- 动态生成统计卡片 -->
        </div>
        
        <!-- 图表区域 -->
        <div class="row">
            <!-- 城市犯罪类型统计 -->
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">各城市主要犯罪类型统计</div>
                    <canvas id="cityCrimeTypeChart"></canvas>
                </div>
            </div>
            
            <!-- 每月犯罪率最高的城市 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">每月犯罪率最高的前5个城市</div>
                    <canvas id="topCrimeCitiesChart"></canvas>
                </div>
            </div>
            
            <!-- 犯罪时间模式 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">犯罪时间分布模式</div>
                    <canvas id="crimeTimePatternChart"></canvas>
                </div>
            </div>
            
            <!-- 犯罪地点类型分析 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">犯罪地点类型分布</div>
                    <canvas id="crimePlaceTypeChart"></canvas>
                </div>
            </div>
            
            <!-- 犯罪趋势分析 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">犯罪数量月度变化趋势</div>
                    <canvas id="crimeTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // 图表对象
        let cityCrimeTypeChart, topCrimeCitiesChart, crimeTimePatternChart, crimePlaceTypeChart, crimeTrendChart;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有图表
            initCharts();
            
            // 加载所有数据
            loadAllData();
        });
        
        // 初始化图表
        function initCharts() {
            // 城市犯罪类型图表
            cityCrimeTypeChart = new Chart(document.getElementById('cityCrimeTypeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '犯罪数量'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '各城市主要犯罪类型统计'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
            
            // 每月犯罪率最高的城市图表
            topCrimeCitiesChart = new Chart(document.getElementById('topCrimeCitiesChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '犯罪数量'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每月犯罪率最高的前5个城市'
                        }
                    }
                }
            });
            
            // 犯罪时间模式图表
            crimeTimePatternChart = new Chart(document.getElementById('crimeTimePatternChart'), {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: '犯罪数量',
                        data: Array(24).fill(0),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '犯罪数量'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '小时'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '一天中犯罪时间分布模式'
                        }
                    }
                }
            });
            
            // 犯罪地点类型图表
            crimePlaceTypeChart = new Chart(document.getElementById('crimePlaceTypeChart'), {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                            '#1abc9c', '#e67e22', '#34495e', '#d35400', '#7f8c8d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '犯罪地点类型分布'
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // 犯罪趋势分析图表
            crimeTrendChart = new Chart(document.getElementById('crimeTrendChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '平均犯罪数量',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '犯罪数量'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '犯罪数量月度变化趋势'
                        }
                    }
                }
            });
        }
        
        // 加载所有数据
        function loadAllData() {
            loadCrimeByCityType();
            loadTopCrimeCitiesMonthly();
            loadCrimeTimePatterns();
            loadCrimeByPlaceType();
            loadCrimeTrendAnalysis();
        }
        
        // 加载按城市和犯罪类型统计的数据
        function loadCrimeByCityType() {
            axios.get(API_BASE_URL + '/crime-by-city-type')
                .then(response => {
                    const data = response.data;
                    updateCityCrimeTypeChart(data);
                    updateStats(data);
                })
                .catch(error => {
                    console.error('加载城市犯罪类型数据失败:', error);
                });
        }
        
        // 加载每月犯罪率最高的城市数据
        function loadTopCrimeCitiesMonthly() {
            axios.get(API_BASE_URL + '/top-crime-cities-monthly')
                .then(response => {
                    const data = response.data;
                    updateTopCrimeCitiesChart(data);
                })
                .catch(error => {
                    console.error('加载每月犯罪率最高的城市数据失败:', error);
                });
        }
        
        // 加载犯罪时间模式数据
        function loadCrimeTimePatterns() {
            axios.get(API_BASE_URL + '/crime-time-patterns')
                .then(response => {
                    const data = response.data;
                    updateCrimeTimePatternChart(data);
                })
                .catch(error => {
                    console.error('加载犯罪时间模式数据失败:', error);
                });
        }
        
        // 加载犯罪地点类型数据
        function loadCrimeByPlaceType() {
            axios.get(API_BASE_URL + '/crime-by-place-type')
                .then(response => {
                    const data = response.data;
                    updateCrimePlaceTypeChart(data);
                })
                .catch(error => {
                    console.error('加载犯罪地点类型数据失败:', error);
                });
        }
        
        // 加载犯罪趋势分析数据
        function loadCrimeTrendAnalysis() {
            axios.get(API_BASE_URL + '/crime-trend-analysis')
                .then(response => {
                    const data = response.data;
                    updateCrimeTrendChart(data);
                })
                .catch(error => {
                    console.error('加载犯罪趋势分析数据失败:', error);
                });
        }
        
        // 更新城市犯罪类型图表
        function updateCityCrimeTypeChart(data) {
            // 提取城市列表（去重）
            const cities = [...new Set(data.map(item => item.city))];
            
            // 提取犯罪类型列表（去重）
            const crimeTypes = [...new Set(data.map(item => item.crimeName))];
            
            // 准备图表数据
            const datasets = crimeTypes.map((type, index) => {
                const colors = [
                    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                    '#1abc9c', '#e67e22', '#34495e', '#d35400', '#7f8c8d'
                ];
                
                return {
                    label: type,
                    data: cities.map(city => {
                        const item = data.find(d => d.city === city && d.crimeName === type);
                        return item ? item.crimeCount : 0;
                    }),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            
            // 更新图表
            cityCrimeTypeChart.data.labels = cities;
            cityCrimeTypeChart.data.datasets = datasets;
            cityCrimeTypeChart.update();
        }
        
        // 更新每月犯罪率最高的城市图表
        function updateTopCrimeCitiesChart(data) {
            // 按月份分组
            const monthGroups = {};
            data.forEach(item => {
                const monthKey = `${item.year}-${item.month.toString().padStart(2, '0')}`;
                if (!monthGroups[monthKey]) {
                    monthGroups[monthKey] = [];
                }
                monthGroups[monthKey].push(item);
            });
            
            // 准备图表数据
            const labels = Object.keys(monthGroups).sort();
            const datasets = [];
            
            // 为每个城市创建一个数据集
            const cities = [...new Set(data.map(item => item.city))];
            cities.forEach((city, index) => {
                const colors = [
                    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                    '#1abc9c', '#e67e22', '#34495e', '#d35400', '#7f8c8d'
                ];
                
                datasets.push({
                    label: city,
                    data: labels.map(month => {
                        const cityData = monthGroups[month].find(item => item.city === city);
                        return cityData ? cityData.crimeCount : null;
                    }),
                    borderColor: colors[index % colors.length],
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    tension: 0.3
                });
            });
            
            // 更新图表
            topCrimeCitiesChart.data.labels = labels;
            topCrimeCitiesChart.data.datasets = datasets;
            topCrimeCitiesChart.update();
        }
        
        // 更新犯罪时间模式图表
        function updateCrimeTimePatternChart(data) {
            // 准备图表数据
            const crimeCounts = Array(24).fill(0);
            data.forEach(item => {
                if (item.hourOfDay >= 0 && item.hourOfDay < 24) {
                    crimeCounts[item.hourOfDay] = item.crimeCount;
                }
            });
            
            // 更新图表
            crimeTimePatternChart.data.datasets[0].data = crimeCounts;
            crimeTimePatternChart.update();
        }
        
        // 更新犯罪地点类型图表
        function updateCrimePlaceTypeChart(data) {
            // 准备图表数据
            const labels = data.map(item => item.place);
            const counts = data.map(item => item.crimeCount);
            
            // 更新图表
            crimePlaceTypeChart.data.labels = labels;
            crimePlaceTypeChart.data.datasets[0].data = counts;
            crimePlaceTypeChart.update();
        }
        
        // 更新犯罪趋势分析图表
        function updateCrimeTrendChart(data) {
            // 按月份分组并计算平均值
            const monthGroups = {};
            data.forEach(item => {
                const monthKey = `${item.year}-${item.month.toString().padStart(2, '0')}`;
                if (!monthGroups[monthKey]) {
                    monthGroups[monthKey] = [];
                }
                monthGroups[monthKey].push(item.monthlyCrime);
            });
            
            // 计算每月平均值
            const labels = Object.keys(monthGroups).sort();
            const avgCrimes = labels.map(month => {
                const crimes = monthGroups[month];
                return crimes.reduce((sum, crime) => sum + crime, 0) / crimes.length;
            });
            
            // 更新图表
            crimeTrendChart.data.labels = labels;
            crimeTrendChart.data.datasets[0].data = avgCrimes;
            crimeTrendChart.update();
        }
        
        // 更新统计卡片
        function updateStats(data) {
            if (!data || data.length === 0) return;
            
            // 计算统计数据
            const totalCrimes = data.reduce((sum, item) => sum + item.crimeCount, 0);
            const totalCities = new Set(data.map(item => item.city)).size;
            const totalCrimeTypes = new Set(data.map(item => item.crimeName)).size;
            const avgVictims = data.reduce((sum, item) => sum + item.avgVictims, 0) / data.length;
            
            // 生成统计卡片
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = `
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">${totalCrimes.toLocaleString()}</div>
                        <div class="stats-label">总犯罪数量</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">${totalCities}</div>
                        <div class="stats-label">涉及城市数量</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">${totalCrimeTypes}</div>
                        <div class="stats-label">犯罪类型数量</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">${avgVictims.toFixed(1)}</div>
                        <div class="stats-label">平均受害者数</div>
                    </div>
                </div>
            `;
        }
    </script>
    
    <!-- 引入Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>