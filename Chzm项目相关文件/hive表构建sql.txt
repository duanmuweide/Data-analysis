----------------------------------------------------Project----------------------------------------------------------------
create database if not exists Data_Analysis ; -- 不分大小写

SET hive.exec.dynamic.partition=true;
SET hive.exec.dynamic.partition.mode=nonstrict;
SET hive.exec.max.dynamic.partitions.pernode=1000;

DROP table watershed_nutrient_balance ;
-- 创建分区+分桶表（按id和year分区，按FIPS分桶，适配53个字段）
CREATE TABLE IF NOT EXISTS watershed_nutrient_balance (
    FIPS INT COMMENT '流域标识编码',
    area_sqkm DOUBLE COMMENT '流域面积(km²)',
    n_farm_fert_kgsqkm DOUBLE COMMENT '农业氮肥料投入（kg N/km²）',
    p_farm_fert_kgsqkm DOUBLE COMMENT '农业磷肥料投入（kg P/km²）',
    n_nonfarm_fert_kgsqkm DOUBLE COMMENT '非农业氮肥料投入（kg N/km²）',
    p_nonfarm_fert_kgsqkm DOUBLE COMMENT '非农业磷肥料投入（kg P/km²）',
    n_total_fert_kgsqkm DOUBLE COMMENT '总氮肥料投入（kg N/km²）',
    p_total_fert_kgsqkm DOUBLE COMMENT '总磷肥料投入（kg P/km²）',
    n_manure_kgsqkm DOUBLE COMMENT '牲畜氮排泄物（kg N/km²）',
    p_manure_kgsqkm DOUBLE COMMENT '牲畜磷排泄物（kg P/km²）',
    n_livestock_dem_kgsqkm DOUBLE COMMENT '牲畜饲料氮需求（kg N/km²）',
    p_livestock_dem_kgsqkm DOUBLE COMMENT '牲畜饲料磷需求（kg P/km²）',
    n_livestock_prod_kgsqkm DOUBLE COMMENT '牲畜产品氮产出（kg N/km²）',
    p_livestock_prod_kgsqkm DOUBLE COMMENT '牲畜产品磷产出（kg P/km²）',
    n_livestock_rec_kgsqkm DOUBLE COMMENT '回收牲畜氮排泄物（kg N/km²）',
    p_livestock_rec_kgsqkm DOUBLE COMMENT '回收牲畜磷排泄物（kg P/km²）',
    n_crop_rem_kgsqkm DOUBLE COMMENT '作物氮移除量（kg N/km²）',
    p_crop_rem_kgsqkm DOUBLE COMMENT '作物磷移除量（kg P/km²）',
    n_pasture_rem_kgsqkm DOUBLE COMMENT '牧场氮移除量（kg N/km²）',
    p_pasture_rem_kgsqkm DOUBLE COMMENT '牧场磷移除量（kg P/km²）',
    n_crop_fix_kgsqkm DOUBLE COMMENT '作物固氮量（kg N/km²）',
    n_human_food_dem_kgsqkm DOUBLE COMMENT '人类食物氮需求（kg N/km²）',
    p_human_food_dem_kgsqkm DOUBLE COMMENT '人类食物磷需求（kg P/km²）',
    n_human_food_waste_kgsqkm DOUBLE COMMENT '人类食物氮废弃物（kg N/km²）',
    p_human_food_waste_kgsqkm DOUBLE COMMENT '人类食物磷废弃物（kg P/km²）',
    p_human_nonfood_dem_kgsqkm DOUBLE COMMENT '人类非食物磷需求（kg P/km²）',
    p_human_nonfood_waste_kgsqkm DOUBLE COMMENT '人类非食物磷废弃物（kg P/km²）',
    p_human_total_dem_kgsqkm DOUBLE COMMENT '人类总磷需求（kg P/km²）',
    p_human_total_waste_kgsqkm DOUBLE COMMENT '人类总磷废弃物（kg P/km²）',
    n_point_source_kgsqkm DOUBLE COMMENT '市政点源氮负荷（kg N/km²）',
    p_point_source_kgsqkm DOUBLE COMMENT '市政点源磷负荷（kg P/km²）',
    n_atm_dep_kgsqkm DOUBLE COMMENT '大气氮沉降量（kg N/km²）',
    p_atm_dep_kgsqkm DOUBLE COMMENT '大气磷沉降量（kg P/km²）',
    n_nat_fix_kgsqkm DOUBLE COMMENT '自然固氮量（kg N/km²）',
    n_rock_kgsqkm DOUBLE COMMENT '岩石氮风化量（kg N/km²）',
    n_emis_total_kgsqkm DOUBLE COMMENT '总大气氮排放量（kg N/km²）',
    n_emis_ag_kgsqkm DOUBLE COMMENT '农业氮排放量（kg N/km²）',
    n_emis_fire_kgsqkm DOUBLE COMMENT '火灾氮排放量（kg N/km²）',
    n_emis_lightning_kgsqkm DOUBLE COMMENT '闪电氮排放量（kg N/km²）',
    n_emis_nonpoint_kgsqkm DOUBLE COMMENT '非点源氮排放量（kg N/km²）',
    n_emis_point_kgsqkm DOUBLE COMMENT '点源氮排放量（kg N/km²）',
    n_emis_transport_kgsqkm DOUBLE COMMENT '交通氮排放量（kg N/km²）',
    n_ag_n2o_kgsqkm DOUBLE COMMENT '农业N₂O排放量（kg N/km²）',
    n_ag_n2_kgsqkm DOUBLE COMMENT '农业N₂排放量（kg N/km²）',
    n_terr_surplus_kgsqkm DOUBLE COMMENT '陆地氮盈余（kg N/km²）',
    p_terr_surplus_kgsqkm DOUBLE COMMENT '陆地磷盈余（kg P/km²）',
    n_ag_surplus_kgsqkm DOUBLE COMMENT '农业氮盈余（kg N/km²）',
    p_ag_surplus_kgsqkm DOUBLE COMMENT '农业磷盈余（kg P/km²）',
    n_leg_ag_surplus_kgsqkm DOUBLE COMMENT ' legacy农业氮盈余（kg N/km²）',
    p_leg_ag_surplus_kgsqkm DOUBLE COMMENT 'legacy农业磷盈余（kg P/km²）',
    n_nue_kgsqkm DOUBLE COMMENT '农业氮利用效率（无单位）',
    p_nue_kgsqkm DOUBLE COMMENT '农业磷利用效率（无单位）'
)
PARTITIONED BY (
    id INT COMMENT '数据批次标识（每次上传递增1）',
    year INT COMMENT '统计年份（从数据中提取）'
)
CLUSTERED BY (FIPS) INTO 8 BUCKETS
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
STORED AS TEXTFILE;


DROP table data_tmp ;
-- 创建一个外部临时表 用于后续进行动态分区插入
CREATE TABLE IF NOT EXISTS data_tmp( 
    FIPS int COMMENT '流域标识编码',
    year INT COMMENT '年份',
    area_sqkm DOUBLE COMMENT '流域面积(km²)',
    n_farm_fert_kgsqkm DOUBLE COMMENT '农业氮肥料投入（kg N/km²）',
    p_farm_fert_kgsqkm DOUBLE COMMENT '农业磷肥料投入（kg P/km²）',
    n_nonfarm_fert_kgsqkm DOUBLE COMMENT '非农业氮肥料投入（kg N/km²）',
    p_nonfarm_fert_kgsqkm DOUBLE COMMENT '非农业磷肥料投入（kg P/km²）',
    n_total_fert_kgsqkm DOUBLE COMMENT '总氮肥料投入（kg N/km²）',
    p_total_fert_kgsqkm DOUBLE COMMENT '总磷肥料投入（kg P/km²）',
    n_manure_kgsqkm DOUBLE COMMENT '牲畜氮排泄物（kg N/km²）',
    p_manure_kgsqkm DOUBLE COMMENT '牲畜磷排泄物（kg P/km²）',
    n_livestock_dem_kgsqkm DOUBLE COMMENT '牲畜饲料氮需求（kg N/km²）',
    p_livestock_dem_kgsqkm DOUBLE COMMENT '牲畜饲料磷需求（kg P/km²）',
    n_livestock_prod_kgsqkm DOUBLE COMMENT '牲畜产品氮产出（kg N/km²）',
    p_livestock_prod_kgsqkm DOUBLE COMMENT '牲畜产品磷产出（kg P/km²）',
    n_livestock_rec_kgsqkm DOUBLE COMMENT '回收牲畜氮排泄物（kg N/km²）',
    p_livestock_rec_kgsqkm DOUBLE COMMENT '回收牲畜磷排泄物（kg P/km²）',
    n_crop_rem_kgsqkm DOUBLE COMMENT '作物氮移除量（kg N/km²）',
    p_crop_rem_kgsqkm DOUBLE COMMENT '作物磷移除量（kg P/km²）',
    n_pasture_rem_kgsqkm DOUBLE COMMENT '牧场氮移除量（kg N/km²）',
    p_pasture_rem_kgsqkm DOUBLE COMMENT '牧场磷移除量（kg P/km²）',
    n_crop_fix_kgsqkm DOUBLE COMMENT '作物固氮量（kg N/km²）',
    n_human_food_dem_kgsqkm DOUBLE COMMENT '人类食物氮需求（kg N/km²）',
    p_human_food_dem_kgsqkm DOUBLE COMMENT '人类食物磷需求（kg P/km²）',
    n_human_food_waste_kgsqkm DOUBLE COMMENT '人类食物氮废弃物（kg N/km²）',
    p_human_food_waste_kgsqkm DOUBLE COMMENT '人类食物磷废弃物（kg P/km²）',
    p_human_nonfood_dem_kgsqkm DOUBLE COMMENT '人类非食物磷需求（kg P/km²）',
    p_human_nonfood_waste_kgsqkm DOUBLE COMMENT '人类非食物磷废弃物（kg P/km²）',
    p_human_total_dem_kgsqkm DOUBLE COMMENT '人类总磷需求（kg P/km²）',
    p_human_total_waste_kgsqkm DOUBLE COMMENT '人类总磷废弃物（kg P/km²）',
    n_point_source_kgsqkm DOUBLE COMMENT '市政点源氮负荷（kg N/km²）',
    p_point_source_kgsqkm DOUBLE COMMENT '市政点源磷负荷（kg P/km²）',
    n_atm_dep_kgsqkm DOUBLE COMMENT '大气氮沉降量（kg N/km²）',
    p_atm_dep_kgsqkm DOUBLE COMMENT '大气磷沉降量（kg P/km²）',
    n_nat_fix_kgsqkm DOUBLE COMMENT '自然固氮量（kg N/km²）',
    n_rock_kgsqkm DOUBLE COMMENT '岩石氮风化量（kg N/km²）',
    n_emis_total_kgsqkm DOUBLE COMMENT '总大气氮排放量（kg N/km²）',
    n_emis_ag_kgsqkm DOUBLE COMMENT '农业氮排放量（kg N/km²）',
    n_emis_fire_kgsqkm DOUBLE COMMENT '火灾氮排放量（kg N/km²）',
    n_emis_lightning_kgsqkm DOUBLE COMMENT '闪电氮排放量（kg N/km²）',
    n_emis_nonpoint_kgsqkm DOUBLE COMMENT '非点源氮排放量（kg N/km²）',
    n_emis_point_kgsqkm DOUBLE COMMENT '点源氮排放量（kg N/km²）',
    n_emis_transport_kgsqkm DOUBLE COMMENT '交通氮排放量（kg N/km²）',
    n_ag_n2o_kgsqkm DOUBLE COMMENT '农业N₂O排放量（kg N/km²）',
    n_ag_n2_kgsqkm DOUBLE COMMENT '农业N₂排放量（kg N/km²）',
    n_terr_surplus_kgsqkm DOUBLE COMMENT '陆地氮盈余（kg N/km²）',
    p_terr_surplus_kgsqkm DOUBLE COMMENT '陆地磷盈余（kg P/km²）',
    n_ag_surplus_kgsqkm DOUBLE COMMENT '农业氮盈余（kg N/km²）',
    p_ag_surplus_kgsqkm DOUBLE COMMENT '农业磷盈余（kg P/km²）',
    n_leg_ag_surplus_kgsqkm DOUBLE COMMENT ' legacy农业氮盈余（kg N/km²）',
    p_leg_ag_surplus_kgsqkm DOUBLE COMMENT 'legacy农业磷盈余（kg P/km²）',
    n_nue_kgsqkm DOUBLE COMMENT '农业氮利用效率（无单位）',
    p_nue_kgsqkm DOUBLE COMMENT '农业磷利用效率（无单位）'
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
STORED AS TEXTFILE
TBLPROPERTIES ('skip.header.line.count'='1');

-- 验证导入结果（查询前10条数据）
SELECT * FROM watershed_nutrient_balance LIMIT 5;
SELECT COUNT(*) FROM watershed_nutrient_balance ; 共211344条数据
DESCRIBE watershed_nutrient_balance;
